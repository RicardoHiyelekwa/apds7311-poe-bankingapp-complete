version: 2.1

orbs:
  node: circleci/node@5.0.0

jobs:
  # ================================
  # Job de Build & Test
  # ================================
  build-and-test:
    docker:
      - image: cimg/node:18.20
    steps:
      - checkout

      # Backend setup
      - run:
          name: Backend setup
          command: |
            cd backend
            npm install
            # Opcional: rodar testes com cobertura
            # npm test -- --coverage

      # Frontend setup
      - run:
          name: Frontend setup
          command: |
            cd frontend
            npm ci
            chmod +x node_modules/.bin/* || true
            npm run build
            # Opcional: rodar testes com cobertura
            # npm test -- --coverage

  # ================================
  # Job de An√°lise SonarQube
  # ================================
  sonar-analysis:
    docker:
      - image: sonarsource/sonar-scanner-cli:latest
    steps:
      - checkout
      - run:
          name: Run SonarQube Analysis
          command: |
            sonar-scanner \
              -Dsonar.host.url=${SONAR_HOST_URL} \
              -Dsonar.login=${SONAR_TOKEN}

# ================================
# Workflow Principal
# ================================
workflows:
  main:
    jobs:
      - build-and-test
      - sonar-analysis:
          requires:
            - build-and-test
